# Inherits the specified variable from the environment (from the parent
# process). By default no evironment variables are inherited.
env					DOMAIN_NAME;

# Defines user (and group) credentials use by worker processes.
user				nginx;

# Defines the number of CPU cores to be utilized (actual usage depends on other
# factors such as actual number of cores, number of hard disk drives etc.).
worker_processes	auto;

# -	Configures the default file for error logging. 
# -	8 levels of logging can be set, starting from 'debug' (lowest) to 'emerg'
# 	(highest). Setting a certain level will cause all messages of the specified
# 	and more severe log levels to be logged.
error_log			/dev/stderr debug;

# Used to set global options that affect how NGINX handles connection at a
# general level.
events {
	# Maximum number of simultaneous connections that can be opened by a worker
	# process.
	worker_connections	1024;
}

# Sets the configuration for HTTP connections.
http {
	# -	'include' includes another file into the configuration. The file should
	# 	consist syntatically correct directives and blocks.
	# -	The NGINX 'mime.types' consists of configuration that maps file name
	# 	extensions to MIME types of responses.
	include 		mime.types;

	# -	'default_type' defines the default MIME type of a response, in the case
	# 	where the type of file extension being dealt with is not defined in
	# 	'mime.types'.
	# -	The 'application/octet-stream' type treats the file as binary, and
	# 	usually browsers will download this sort of file rather than trying to
	# 	display it.
	default_type	application/octet-stream;

	# -	Specifies the log format (for access logs particularly).
	# -	'main' is just a name/reference for the format (see next directive).
	log_format		main '$remote_addr - $remote_user [$time_local] "$request" '
						 '$status $body_bytes_sent "$http_referer" '
						 '"$http_user_agent" "$http_x_forwarded_for"';

	# -	Sets the path, format, and configuration for a buffered log write.
	# -	The format used here is 'main', referring to the previous directive.
	access_log 		/dev/stdout main;

	# Sendfile copies data between one FD and other from within the kernel,
	# which is more efficient than read() + write(). Default is off.
	sendfile		on;

	# Don't tell nginx version to the clients. Default is 'on'.
	server_tokens	off;

	# Sets configuration for a virtual server (Multiple servers require their
	# own block each).
	server {
		# - Sets the IP:Port or the path for a UNIX-domain socket on which the
		# 	server will accept request.
		# -	For an HTTPS server, the 'ssl' parameter must be specified after
		# 	the socket.
		# -	The 'default_server' sets the server as the default for the
		# 	specified IP:Port.
		listen						443 ssl default_server;
		
		# -	Enables the specified protocols.
		# -	In general, Transport Layer Security (TLS) provides encryption,
		# 	authentication, and integrity in HTTP connections.
		ssl_protocols				TLSv1.3;

		# Sets names for a virtual server.
		server_name					$DOMAIN_NAME www.$DOMAIN_NAME;

		# Specify certificate to be used for initial authentication phase 
		# during a TLS handshake. Certificate, including public key, of client
		# and server are exchanged during the handshake.
		ssl_certificate				/run/secrets/server.rsa.crt;

		# Specify private key to be used in the middle of authentication during
		# a TLS handshake. It is used to decrypt the "premaster", which was
		# encrypted by the client using the server's public key obtained from
		# the SSL certificate.
		ssl_certificate_key			/run/secrets/server.rsa.key;

		# Specifies that our cipher suits should be preferred over client
		# ciphers. Default is 'off'.
		ssl_prefer_server_ciphers	on;

		# Sets the root directory for requests. When parsing requests, a file
		# path is constructed by merely adding a URI to the value of the root
		# direction (e.g. localhost/index.html => /var/www/html/index.html).
		root						/var/www/html/;

		# -	Sets configuration depending on the URI.
		# -	Several prefixes ('=', '~', '~*', '^~') can be specified to match
		# 	with various cases of URI (in order of priority):
		#	  1) '='		: Exact match
		#	  2) '^~'		: Longest-prefix match (without regular expression)
		#	  4) '~' '~*'	: Regular expression match (case sensitive and
		# 					  insensitive)
		#	  3) none		: Longest-prefix match
		# - An '@' prefix can also be used to specify a named location, and
		#	this is used for request redirection than regular request
		# 	processing.
		location = / {
			# -	Stops processing and returns the specified code to the client.
			# -	With code 301 (and several others such as 302, 307), it is
			# 	possible to specify a redirect URL.
			return 301 /index.php;
		}

		location ~* \.php$ {
			# -	Checks the existence of files or directories (with a '/' at the
			# 	end) in the specified order of URI (only one specified here,
			# 	'$uri') and uses the first found result for request processing
			# 	in the current context.
			# -	If there is no result a code can be returned. In this case, the
			# 	statement checks the existence of the PHP file before passing
			#	the request to the FastCGI server (below).
			# - Instead of a code a URI can be specified, which would lead to
			# 	an internal redirect to the specified URI.
			try_files		$uri =404;

			# The NGINX 'fastcgi.conf' contains configuration necessary for the
			# PHP-FPM server. There is another file named 'fastcgi_params' that
			# is virtually the same as 'fastcgi.conf' except for one (or a few)
			# directives, and this file is more suitable for general FastCGI
			# applications.
			include			fastcgi.conf;

			# Sets the address of a FastCGI server for PHP requests to be
			# passed to (in this case).
			fastcgi_pass	wordpress-php:9000;
		}

		location ~ ^/(status|ping) {
			include			fastcgi.conf;
			fastcgi_pass	wordpress-php:9001;
		}

		location = /realtime {
			try_files	$uri /status.html;
		}

		location = /status.html {
			root	/usr/share/php83/fpm/;
		}

	}

	server {
		listen		80 default_server;
		server_name	$DOMAIN_NAME www.$DOMAIN_NAME;

		# $host specifies the hostname or domain name such as 'foo.com' and
		# $request_uri specifies the rest of the full path of URL/URI such as
		# '/index.html' in 'foo.com/index.html'
		return		301 https://$host$request_uri;
	}
}